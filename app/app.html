<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAMERYT Calculator</title>
    
    <!-- PWA and Offline Support -->
    <meta name="theme-color" content="#4c1d95"/>
    <link rel="manifest" href="/GAMERYT-Calculator/manifest.json">
    <link rel="apple-touch-icon" href="/GAMERYT-Calculator/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-start-dark: #581c87; /* Purple-ish */
            --background-end-dark: #db2777;   /* Pink-ish */
            --background-start-light: #fbcfe8;
            --background-end-light: #dbeafe;
        }
        html.dark body {
            background-image: linear-gradient(to right, var(--background-start-dark), var(--background-end-dark));
        }
        html:not(.dark) body {
            background-image: linear-gradient(to right, var(--background-start-light), var(--background-end-light));
        }
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="datetime-local"] {
            background-color: #334155;
            border: 1px solid #475569;
            color-scheme: dark;
        }
        #more-sci-functions {
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #more-sci-functions.visible {
            max-height: 500px; /* Adjust as needed */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans transition-colors duration-300">

    <div id="app-container" class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-slate-900/30 backdrop-blur-md text-white w-64 flex flex-col flex-shrink-0 transition-all duration-300 ease-in-out -translate-x-full sm:translate-x-0">
            <div class="p-4 flex items-center justify-between h-16 border-b border-slate-700/50 flex-shrink-0">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-pink-400">calculate</span>
                    <h1 class="text-xl font-bold ml-2 sidebar-text">Calculator</h1>
                </div>
                <button id="sidebar-close-btn" class="sm:hidden p-2 rounded-md hover:bg-slate-700">
                     <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <nav id="sidebar-nav" class="p-4 space-y-2 overflow-y-auto">
                 <div id="sidebar-main-nav" class="space-y-2">
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="standard">
                        <span class="material-symbols-outlined">dialpad</span><span class="ml-3 sidebar-text">Standard</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="time">
                        <span class="material-symbols-outlined">schedule</span><span class="ml-3 sidebar-text">Time</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="storage">
                        <span class="material-symbols-outlined">database</span><span class="ml-3 sidebar-text">Storage</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="currency">
                        <span class="material-symbols-outlined">payments</span><span class="ml-3 sidebar-text">Currency</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="angle">
                        <span class="material-symbols-outlined">square_foot</span><span class="ml-3 sidebar-text">Angle</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="pressure">
                        <span class="material-symbols-outlined">compress</span><span class="ml-3 sidebar-text">Pressure</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="weight">
                        <span class="material-symbols-outlined">fitness_center</span><span class="ml-3 sidebar-text">Weight</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="speed">
                        <span class="material-symbols-outlined">speed</span><span class="ml-3 sidebar-text">Speed</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="temp">
                        <span class="material-symbols-outlined">thermostat</span><span class="ml-3 sidebar-text">Temp</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="length">
                        <span class="material-symbols-outlined">straighten</span><span class="ml-3 sidebar-text">Length</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="fuel">
                        <span class="material-symbols-outlined">local_gas_station</span><span class="ml-3 sidebar-text">Fuel</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="volume">
                        <span class="material-symbols-outlined">science</span><span class="ml-3 sidebar-text">Volume</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="area">
                        <span class="material-symbols-outlined">view_in_ar</span><span class="ml-3 sidebar-text">Area</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="power">
                        <span class="material-symbols-outlined">bolt</span><span class="ml-3 sidebar-text">Power</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="energy">
                        <span class="material-symbols-outlined">local_fire_department</span><span class="ml-3 sidebar-text">Energy</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="force">
                        <span class="material-symbols-outlined">moving</span><span class="ml-3 sidebar-text">Force</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="percent">
                        <span class="material-symbols-outlined">thumb_up</span><span class="ml-3 sidebar-text">Check %</span></button>
                    <button class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50" data-page="settings">
                        <span class="material-symbols-outlined">settings</span><span class="ml-3 sidebar-text">Settings</span></button>
                 </div>
                 <div id="sidebar-more-container" class="hidden relative">
                    <button id="sidebar-more-btn" class="flex items-center p-2 text-base w-full font-normal text-slate-300 rounded-lg hover:bg-slate-700/50">
                        <span class="material-symbols-outlined">more_horiz</span><span class="ml-3 sidebar-text">More</span>
                    </button>
                    <div id="sidebar-more-menu" class="hidden absolute bottom-full left-0 mb-2 w-full p-2 bg-slate-800 rounded-lg shadow-lg z-20 space-y-2 overflow-y-auto max-h-64">
                        <!-- Collapsed items go here -->
                    </div>
                 </div>
                 <a id="sidebar-contact-btn" href="https://mail.google.com/mail/u/0/?fs=1&tf=cm&source=mailto&to=minecraftgamer97529@gmail.com" target="_blank" class="hidden items-center p-2 text-base font-normal text-slate-300 rounded-lg hover:bg-slate-700/50">
                    <span class="material-symbols-outlined">email</span><span class="ml-3 sidebar-text">Contact</span></a>
            </nav>
        </aside>

        <!-- Main Viewport -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Topbar -->
            <header id="topbar" class="bg-slate-900/30 backdrop-blur-md text-white flex-shrink-0">
                <div class="flex items-center justify-between p-4 h-16 border-b border-slate-700/50">
                    <div class="flex items-center">
                        <button id="menu-btn" class="sm:hidden mr-2 p-2 rounded-md hover:bg-slate-700">
                            <span class="material-symbols-outlined">menu</span>
                        </button>
                    </div>
                    <div id="search-bar-wrapper" class="flex-1 flex justify-center">
                        <div id="desktop-search-container" class="relative w-full" style="max-width: 800px;">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                            <input id="history-search" type="text" placeholder="Search History" class="bg-slate-800/50 border border-slate-700 rounded-lg w-full pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-2">
                        <a id="desktop-contact-btn" href="https://mail.google.com/mail/u/0/?fs=1&tf=cm&source=mailto&to=minecraftgamer97529@gmail.com" target="_blank" class="flex items-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-sm mr-1">email</span>
                            <span id="contact-btn-text">Contact</span>
                        </a>
                        <button id="mobile-search-btn" class="hidden p-2 rounded-full hover:bg-slate-700">
                            <span class="material-symbols-outlined">search</span>
                        </button>
                        <button id="history-btn" class="p-2 rounded-full hover:bg-slate-700">
                            <span class="material-symbols-outlined">history</span>
                        </button>
                        <button id="ai-btn" class="p-2 rounded-full hover:bg-slate-700">
                            <span class="material-symbols-outlined">smart_toy</span>
                        </button>
                    </div>
                </div>
                 <!-- Mobile Search -->
                <div id="mobile-search-view" class="hidden p-2 bg-slate-800">
                    <div class="flex items-center">
                        <button id="mobile-search-back-btn" class="p-2 rounded-full hover:bg-slate-700">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <input id="mobile-history-search" type="text" placeholder="Search History..." class="bg-transparent w-full ml-2 focus:outline-none">
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 flex flex-row overflow-hidden">
                <main id="main-content" class="flex-1 flex flex-col overflow-y-auto">
                    <!-- Dynamic content goes here -->
                </main>

                <!-- Right Panels -->
                <aside id="right-panels" class="bg-slate-900/30 backdrop-blur-md flex-shrink-0 border-l border-slate-700/50 flex flex-col relative">
                    <button id="right-panel-close-btn" class="absolute top-2 right-2 p-2 rounded-full hover:bg-slate-700/50 z-10 hidden">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                    <!-- This is a persistent container for the panels -->
                </aside>
            </div>
        </div>

        <!-- Mobile Bottom Sheet -->
        <div id="mobile-bottom-sheet" class="fixed bottom-0 left-0 right-0 h-1/2 bg-slate-800 transform translate-y-full transition-transform duration-300 ease-in-out flex flex-col">
            <div id="sheet-header" class="p-4 border-b border-slate-700/50 flex justify-between items-center flex-shrink-0">
                 <h2 id="sheet-title" class="text-lg font-bold"></h2>
                 <button id="sheet-close-btn"><span class="material-symbols-outlined">expand_more</span></button>
            </div>
            <div id="sheet-content" class="flex-1 overflow-y-auto">
                <!-- Mobile history/ai content will be moved here -->
            </div>
        </div>

        <!-- Panel Templates (kept out of sight, ready to be moved) -->
        <div id="panel-templates" class="hidden">
            <div id="history-panel" class="flex flex-col h-full">
                <h2 class="text-lg font-bold p-4 border-b border-slate-700/50 flex-shrink-0">History</h2>
                <div id="history-list" class="flex-1 p-4 space-y-2 overflow-y-auto no-scrollbar">
                   <!-- History items go here -->
                </div>
                <button id="clear-history-btn" class="m-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Clear History</button>
            </div>
            <div id="ai-panel" class="flex flex-col h-full">
                <h2 class="text-lg font-bold p-4 border-b border-slate-700/50 flex-shrink-0">AI Assistant</h2>
                <div class="flex-1 p-4 flex flex-col overflow-hidden">
                    <div id="ai-output" class="flex-1 bg-slate-800/50 rounded-lg p-2 mb-4 overflow-y-auto no-scrollbar"></div>
                    <div class="flex flex-shrink-0">
                        <input id="ai-input" type="text" placeholder="Ask AI..." class="bg-slate-800/50 border border-slate-700 rounded-l-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <button id="ai-submit-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-2 rounded-r-lg">
                            <span class="material-symbols-outlined">send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/GAMERYT-Calculator/sw.js')
              .then(registration => {
                console.log('Service Worker registered: ', registration);
              })
              .catch(registrationError => {
                console.log('Service Worker registration failed: ', registrationError);
              });
          });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            const state = {
                currentPage: 'standard',
                history: JSON.parse(localStorage.getItem('calculatorHistory')) || [],
                likesDislikesHistory: JSON.parse(localStorage.getItem('likesDislikesHistory')) || [],
                settings: {
                    darkMode: localStorage.getItem('darkMode') !== 'false',
                    showDecimals: localStorage.getItem('showDecimals') !== 'false',
                    advancedMode: localStorage.getItem('advancedMode') === 'true',
                },
                calc: {
                    memory: 0,
                    is2ndFlipped: false,
                    isRad: false, // false for DEG, true for RAD
                    showMoreSci: false,
                },
                isSidebarOpen: false,
                isRightPanelOpen: true,
                rightPanelContent: 'history',
                isMobileSheetOpen: false,
                mobileSheetContent: 'history'
            };

            // --- SELECTORS ---
            const mainContent = document.getElementById('main-content');
            const sidebarNav = document.getElementById('sidebar-nav');
            const menuBtn = document.getElementById('menu-btn');
            const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
            
            const rightPanelsContainer = document.getElementById('right-panels');
            const rightPanelCloseBtn = document.getElementById('right-panel-close-btn');
            const panelTemplates = document.getElementById('panel-templates');
            const historyPanel = document.getElementById('history-panel');
            const aiPanel = document.getElementById('ai-panel');
            
            const historyBtn = document.getElementById('history-btn');
            const aiBtn = document.getElementById('ai-btn');
            const historyList = document.getElementById('history-list');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const historySearchInput = document.getElementById('history-search');
            const mobileHistorySearchInput = document.getElementById('mobile-history-search');

            const aiInput = document.getElementById('ai-input');
            const aiOutput = document.getElementById('ai-output');
            const aiSubmitBtn = document.getElementById('ai-submit-btn');

            const mobileSearchBtn = document.getElementById('mobile-search-btn');
            const mobileSearchView = document.getElementById('mobile-search-view');
            const mobileSearchBackBtn = document.getElementById('mobile-search-back-btn');
            const mobileBottomSheet = document.getElementById('mobile-bottom-sheet');
            const sheetTitle = document.getElementById('sheet-title');
            const sheetContent = document.getElementById('sheet-content');
            const sheetCloseBtn = document.getElementById('sheet-close-btn');
            
            // --- TEMPLATES ---
            const getStandardCalculatorHTML = () => {
                const advancedMode = state.settings.advancedMode;
                const gridClass = advancedMode ? 'grid-cols-5' : 'grid-cols-4';

                const advancedButtons = `
                    <div id="advanced-buttons" class="grid grid-cols-2 gap-2">
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="toggle-more">more</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="rad-deg">${state.calc.isRad ? 'RAD' : 'DEG'}</button>
                        
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="(">(</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key=")">)</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="mc">mc</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="m+">m+</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="m-">m-</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="mr">mr</button>
                        
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="2nd">2nd</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="x^2">x²</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="x^3">x³</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="x^y">xʸ</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="e^x">eˣ</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="10^x">10ˣ</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="1/x">1/x</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="sqrt">√</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="cbrt">∛</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="y_sqrt_x">ʸ√x</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="+/-">+/-</button>
                        <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="pi">π</button>

                        <div id="more-sci-functions" class="col-span-2 grid grid-cols-2 gap-2 ${state.calc.showMoreSci ? 'visible' : ''}">
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="ln">ln</button>
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="log10">log₁₀</button>
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="x!">x!</button>
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="sin">sin</button>
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="cos">cos</button>
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="tan">tan</button>
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="e">e</button>
                            <button class="text-base bg-purple-800 hover:bg-purple-900 text-white font-bold rounded-lg transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="EE">EE</button>
                        </div>
                    </div>
                `;

                return `
                <div id="calculator" class="w-full max-w-2xl mx-auto h-full bg-slate-900/50 rounded-xl shadow-lg p-4 flex flex-col">
                    <div class="relative">
                        <div id="expression-display" class="text-right text-slate-400 text-2xl h-8 pr-4 break-all truncate"></div>
                        <div id="display" class="bg-slate-800/60 text-right text-white p-4 rounded-lg text-5xl overflow-x-auto no-scrollbar break-all flex-shrink-0">0</div>
                    </div>
                    <div class="flex-grow mt-4 flex gap-2">
                        ${advancedMode ? advancedButtons : ''}
                        <div class="grid ${gridClass} gap-2 flex-grow">
                            <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="AC">AC</button>
                            <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="DEL">DEL</button>
                            <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="%">%</button>
                            <button class="bg-pink-600 hover:bg-pink-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="/">÷</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="7">7</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="8">8</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="9">9</button>
                            <button class="bg-pink-600 hover:bg-pink-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="*">x</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="4">4</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="5">5</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="6">6</button>
                            <button class="bg-pink-600 hover:bg-pink-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="-">-</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="1">1</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="2">2</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="3">3</button>
                            <button class="bg-pink-600 hover:bg-pink-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="+">+</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center ${advancedMode ? '' : 'col-span-2'}" data-key="0">0</button>
                            <button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key=".">.</button>
                            <button class="bg-pink-600 hover:bg-pink-700 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center" data-key="=">=</button>
                            ${advancedMode ? '<button class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold rounded-lg text-xl transition-all duration-200 active:scale-95 flex justify-center items-center col-span-2" data-key="00">00</button>' : ''}
                        </div>
                    </div>
                </div>`;
            }
            
            const getTimeCalculatorHTML = () => `
                <div class="w-full max-w-2xl mx-auto p-4 md:p-6 space-y-8">
                    <div class="bg-slate-900/50 rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-pink-400 mb-4">Time Difference</h3>
                        <div class="flex flex-wrap -mx-2 items-end">
                            <div class="px-2 w-full md:w-1/2 mb-4 md:mb-0">
                                <label for="start-time" class="block text-sm font-medium text-slate-300 mb-1">Start Date & Time</label>
                                <input type="datetime-local" id="start-time" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-pink-500">
                            </div>
                            <div class="px-2 w-full md:w-1/2">
                                <label for="end-time" class="block text-sm font-medium text-slate-300 mb-1">End Date & Time</label>
                                <input type="datetime-local" id="end-time" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-pink-500">
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="calc-diff-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">Calculate Difference</button>
                        </div>
                        <div id="diff-result" class="text-center text-lg md:text-xl font-bold pt-4 mt-4 border-t border-slate-700/50 min-h-[2.25rem]"></div>
                    </div>
                    <div class="bg-slate-900/50 rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-pink-400 mb-4">Add/Subtract Time</h3>
                        <div>
                             <label for="base-time" class="block text-sm font-medium text-slate-300 mb-1">Base Date & Time</label>
                             <input type="datetime-local" id="base-time" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div class="flex flex-wrap -mx-2 mt-4">
                            <div class="w-1/2 sm:w-1/4 px-2 mb-2"><label for="add-days" class="block text-sm text-center">Days</label><input type="number" id="add-days" min="0" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 text-center" placeholder="0"></div>
                            <div class="w-1/2 sm:w-1/4 px-2 mb-2"><label for="add-hours" class="block text-sm text-center">Hours</label><input type="number" id="add-hours" min="0" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 text-center" placeholder="0"></div>
                            <div class="w-1/2 sm:w-1/4 px-2 mb-2"><label for="add-mins" class="block text-sm text-center">Minutes</label><input type="number" id="add-mins" min="0" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 text-center" placeholder="0"></div>
                            <div class="w-1/2 sm:w-1/4 px-2 mb-2"><label for="add-secs" class="block text-sm text-center">Seconds</label><input type="number" id="add-secs" min="0" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 text-center" placeholder="0"></div>
                        </div>
                        <div class="flex justify-center gap-4 mt-6">
                            <button id="add-time-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg">Add</button>
                            <button id="subtract-time-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-5 rounded-lg">Subtract</button>
                        </div>
                        <div id="add-subtract-result" class="text-center text-lg md:text-xl font-bold pt-4 mt-4 border-t border-slate-700/50 min-h-[2.25rem]"></div>
                    </div>
                </div>`;
            
            const getConverterHTML = (title, units) => {
                const options = units.map(u => `<option value="${u.value}">${u.name}</option>`).join('');
                return `<div class="w-full max-w-lg mx-auto bg-slate-900/50 rounded-xl shadow-lg p-6 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-pink-400">${title} Converter</h2>
                    <div class="space-y-4">
                         <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">From</label>
                            <div class="flex flex-wrap gap-2">
                                <input type="number" id="converter-input" class="flex-grow w-full min-w-[100px] p-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Enter value">
                                <select id="from-unit" class="flex-grow w-full min-w-[100px] p-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-pink-500">${options}</select>
                            </div>
                         </div>
                         <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">To</label>
                            <select id="to-unit" class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-pink-500">${options}</select>
                         </div>
                    </div>
                    <div class="text-center">
                        <button id="convert-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">Convert</button>
                    </div>
                    <div id="converter-result" class="text-center text-xl font-bold pt-4"></div>
                </div>`;
            };
            
            const getLikesDislikesHTML = () => `
                <div class="w-full max-w-4xl mx-auto p-4 md:p-6 space-y-4 h-full flex flex-col">
                    <h2 class="text-3xl font-bold text-pink-400 flex-shrink-0">Check %</h2>
                    <div class="bg-slate-900/50 rounded-xl shadow-lg p-4 flex-shrink-0 flex flex-wrap items-center gap-4">
                        <label for="likes-input" class="font-medium">Likes:</label>
                        <input type="number" id="likes-input" class="bg-slate-800/60 border border-slate-700 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-pink-500 w-24" placeholder="12" min="0">
                        <label for="dislikes-input" class="font-medium">Dislikes:</label>
                        <input type="number" id="dislikes-input" class="bg-slate-800/60 border border-slate-700 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-pink-500 w-24" placeholder="23" min="0">
                        <button id="likes-submit-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 ml-auto">
                            <span class="material-symbols-outlined">send</span> Submit</button>
                    </div>
                    <div class="flex-grow bg-slate-900/50 rounded-xl shadow-lg mt-4 flex flex-col overflow-hidden">
                         <h3 class="text-xl font-bold p-4 border-b border-slate-700/50 flex-shrink-0">History</h3>
                         <div id="likes-history-container" class="space-y-4 p-4 overflow-y-auto no-scrollbar"></div>
                    </div></div>`;


            const getSettingsHTML = () => `
                <div class="w-full max-w-2xl mx-auto p-4 md:p-6 space-y-8">
                    <div class="bg-slate-900/50 rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-center text-pink-400 mb-4">Settings</h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-800/50">
                                <label for="dark-mode-toggle" class="text-lg">Dark Mode</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="dark-mode-toggle" id="dark-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="dark-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-800/50">
                                <label for="decimals-toggle" class="text-lg">Show Decimals</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="decimals-toggle" id="decimals-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="decimals-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-800/50">
                                <label for="advanced-mode-toggle" class="text-lg">Advanced Mode</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="advanced-mode-toggle" id="advanced-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="advanced-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-900/50 rounded-xl shadow-lg p-6">
                         <h2 class="text-2xl font-bold text-center text-pink-400 mb-4">Changelog</h2>
                         <div class="space-y-3 text-slate-300 max-h-64 overflow-y-auto">
                            <div><strong class="text-purple-400">v1.7.0</strong><ul class="list-disc list-inside pl-2"><li>Added Offline Support (PWA).</li></ul></div>
                            <div><strong class="text-purple-400">v1.6.2</strong><ul class="list-disc list-inside pl-2"><li>Added Fuel, Volume, Area, Power, Energy, and Force converters.</li></ul></div>
                            <div><strong class="text-purple-400">v1.6.0</strong><ul class="list-disc list-inside pl-2"><li>Added full scientific calculator functionality in Advanced Mode.</li><li>Includes memory functions, trigonometry, logarithms, powers, and more.</li><li>New 5-column layout for advanced mode.</li></ul></div>
                            <div><strong class="text-purple-400">v1.5.3</strong><ul class="list-disc list-inside pl-2"><li>Added Storage Converter.</li><li>Added Advanced Mode toggle in settings.</li><li>Major responsiveness overhaul for a more fluid experience on all screen sizes.</li></ul></div>
                            <div><strong class="text-purple-400">v1.5.2</strong><ul class="list-disc list-inside pl-2"><li>Added Angle & Currency Converters.</li><li>Upgraded AI to solve more query types.</li><li>Added Copy & Delete to history items.</li></ul></div>
                            <div><strong class="text-purple-400">v1.5.1</strong><ul class="list-disc list-inside pl-2"><li>Adjusted responsive width of the right-side panel.</li></ul></div>
                            <div><strong class="text-purple-400">v1.5.0</strong><ul class="list-disc list-inside pl-2"><li>Added Pressure Converter.</li><li>Added Changelog to Settings page.</li></ul></div>
                            <div><strong class="text-purple-400">v1.4.0</strong><ul class="list-disc list-inside pl-2"><li>Added Time Calculator.</li><li>Restored 'DEL' and '%' buttons.</li></ul></div>
                            <div><strong class="text-purple-400">v1.3.0</strong><ul class="list-disc list-inside pl-2"><li>Added advanced 'Check %' for Likes vs. Dislikes.</li></ul></div>
                            <div><strong class="text-purple-400">v1.2.0</strong><ul class="list-disc list-inside pl-2"><li>Major mobile responsiveness overhaul.</li></ul></div>
                            <div><strong class="text-purple-400">v1.0.0</strong><ul class="list-disc list-inside pl-2"><li>Initial release of GAMERYT Calculator.</li></ul></div>
                         </div>
                    </div>
                </div>
                <style>.toggle-checkbox:checked { right: 0; border-color: #ec4899; } .toggle-checkbox:checked + .toggle-label { background-color: #ec4899; }</style>`;
            
            // --- RENDER & LOGIC FUNCTIONS ---
            function renderPage(page) {
                state.currentPage = page;
                mainContent.innerHTML = '';
                mainContent.style.padding = page === 'standard' ? '0' : '';
                const pages = {
                    standard: getStandardCalculatorHTML,
                    time: getTimeCalculatorHTML,
                    storage: () => getConverterHTML('Storage', [{name:'Bytes',value:'b'},{name:'Kilobytes (KB)',value:'kb'},{name:'Megabytes (MB)',value:'mb'},{name:'Gigabytes (GB)',value:'gb'},{name:'Terabytes (TB)',value:'tb'}]),
                    currency: () => getConverterHTML('Currency', [{name:'USD',value:'usd'},{name:'EUR',value:'eur'},{name:'GBP',value:'gbp'},{name:'JPY',value:'jpy'},{name:'CAD',value:'cad'}]),
                    angle: () => getConverterHTML('Angle', [{name:'Degrees',value:'deg'},{name:'Radians',value:'rad'},{name:'Gradians',value:'grad'}]),
                    pressure: () => getConverterHTML('Pressure', [{name:'Pascals (Pa)',value:'pa'},{name:'Kilopascals (kPa)',value:'kpa'},{name:'Bars (bar)',value:'bar'},{name:'PSI',value:'psi'},{name:'Atmospheres (atm)',value:'atm'}]),
                    weight: () => getConverterHTML('Weight', [{name:'Kilograms',value:'kg'},{name:'Grams',value:'g'},{name:'Pounds',value:'lb'},{name:'Ounces',value:'oz'}]),
                    speed: () => getConverterHTML('Speed', [{name:'m/s',value:'mps'},{name:'km/h',value:'kmph'},{name:'mph',value:'mph'},{name:'knots',value:'knots'}]),
                    temp: () => getConverterHTML('Temperature', [{name:'Celsius',value:'c'},{name:'Fahrenheit',value:'f'},{name:'Kelvin',value:'k'}]),
                    length: () => getConverterHTML('Length', [{name:'Meters',value:'m'},{name:'Kilometers',value:'km'},{name:'Centimeters',value:'cm'},{name:'Miles',value:'mi'},{name:'Yards',value:'yd'}]),
                    fuel: () => getConverterHTML('Fuel Efficiency', [{name:'MPG (US)',value:'mpg_us'},{name:'L/100km',value:'l_100km'},{name:'km/L',value:'km_l'}]),
                    volume: () => getConverterHTML('Volume', [{name:'Liters',value:'l'},{name:'Milliliters',value:'ml'},{name:'Gallons (US)',value:'gal_us'},{name:'Cubic Meters',value:'m3'}]),
                    area: () => getConverterHTML('Area', [{name:'Square Meters',value:'m2'},{name:'Square Kilometers',value:'km2'},{name:'Square Miles',value:'mi2'},{name:'Acres',value:'acre'}]),
                    power: () => getConverterHTML('Power', [{name:'Watts',value:'w'},{name:'Kilowatts',value:'kw'},{name:'Horsepower',value:'hp'}]),
                    energy: () => getConverterHTML('Energy', [{name:'Joules',value:'j'},{name:'Kilojoules',value:'kj'},{name:'Calories',value:'cal'},{name:'Kilowatt-hours',value:'kwh'}]),
                    force: () => getConverterHTML('Force', [{name:'Newtons',value:'n'},{name:'Pound-force',value:'lbf'}]),
                    percent: getLikesDislikesHTML, 
                    settings: getSettingsHTML
                };
                const listeners = {
                    standard: attachStandardCalculatorListeners,
                    time: attachTimeCalculatorListeners,
                    storage: () => attachConverterListeners('storage'),
                    currency: () => attachConverterListeners('currency'),
                    angle: () => attachConverterListeners('angle'),
                    pressure: () => attachConverterListeners('pressure'),
                    weight: () => attachConverterListeners('weight'),
                    speed: () => attachConverterListeners('speed'), 
                    temp: () => attachConverterListeners('temp'),
                    length: () => attachConverterListeners('length'), 
                    fuel: () => attachConverterListeners('fuel'),
                    volume: () => attachConverterListeners('volume'),
                    area: () => attachConverterListeners('area'),
                    power: () => attachConverterListeners('power'),
                    energy: () => attachConverterListeners('energy'),
                    force: () => attachConverterListeners('force'),
                    percent: attachLikesDislikesListeners, 
                    settings: attachSettingsListeners
                };
                mainContent.innerHTML = pages[page]();
                listeners[page]();
                updateActiveNav();
            }

            function renderHistory(filter = '') {
                const listElem = (state.isMobileSheetOpen && sheetContent.contains(historyPanel)) 
                    ? sheetContent.querySelector('#history-list') 
                    : historyList;

                if (!listElem) return;

                const filteredHistory = state.history.filter(item => item.toLowerCase().includes(filter.toLowerCase()));
                listElem.innerHTML = filteredHistory.length ? filteredHistory.map((item, index) =>
                    `<div class="bg-slate-800/50 p-2 rounded-lg flex items-center justify-between">
                        <span class="history-text truncate pr-2">${item}</span>
                        <div class="flex items-center flex-shrink-0">
                            <button class="p-1 hover:bg-purple-700/50 rounded-full copy-btn" data-index="${index}" title="Copy">
                                <span class="material-symbols-outlined text-sm">content_copy</span>
                            </button>
                            <button class="p-1 hover:bg-red-700/50 rounded-full delete-btn" data-index="${index}" title="Delete">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                     </div>`
                ).join('') : '<p class="text-slate-400 text-center">No history yet.</p>';
            }

            function updateUI() {
                document.documentElement.classList.toggle('dark', state.settings.darkMode);
                const width = window.innerWidth;
                const sidebar = document.getElementById('sidebar');
                const searchBarWrapper = document.getElementById('search-bar-wrapper');
                const desktopSearchContainer = document.getElementById('desktop-search-container');
                const mobileSearchBtn = document.getElementById('mobile-search-btn');
                const contactBtn = document.getElementById('desktop-contact-btn');
                const contactBtnText = document.getElementById('contact-btn-text');
                const sidebarContactBtn = document.getElementById('sidebar-contact-btn');
                
                // --- Universal Resets ---
                rightPanelsContainer.classList.remove('fixed', 'top-0', 'right-0', 'h-full', 'z-30');
                rightPanelsContainer.style.width = '';
                rightPanelCloseBtn.classList.add('hidden');
                
                // --- Breakpoint-driven logic ---
                
                // < 768px (Mobile & Small Tablet View)
                if (width < 768) {
                    rightPanelsContainer.classList.add('hidden');
                    if (rightPanelsContainer.contains(historyPanel)) panelTemplates.appendChild(historyPanel);
                    if (rightPanelsContainer.contains(aiPanel)) panelTemplates.appendChild(aiPanel);

                    if (width < 600) { // Pure Mobile
                        sidebar.classList.add('fixed', 'top-0', 'left-0', 'h-full', 'z-40');
                        sidebar.style.transform = state.isSidebarOpen ? 'translateX(0)' : 'translateX(-100%)';
                        sidebar.style.width = '256px';
                        document.querySelectorAll('.sidebar-text').forEach(el => el.classList.remove('hidden'));
                        contactBtn.classList.add('hidden');
                        sidebarContactBtn.classList.remove('hidden');
                        sidebarContactBtn.classList.add('flex');
                        desktopSearchContainer.classList.add('hidden');
                        mobileSearchBtn.classList.remove('hidden');
                    } else { // 600px to 768px
                        if(state.isMobileSheetOpen) toggleMobileSheet(false);
                        sidebar.classList.remove('fixed', 'top-0', 'left-0', 'h-full', 'z-40');
                        sidebar.style.transform = 'translateX(0)';
                        state.isSidebarOpen = false;
                        sidebar.style.width = '70px';
                        document.querySelectorAll('.sidebar-text').forEach(el => el.classList.add('hidden'));
                        
                        contactBtn.classList.remove('hidden');
                        contactBtnText.classList.add('hidden');
                        contactBtn.querySelector('.material-symbols-outlined').classList.remove('mr-1');
                        sidebarContactBtn.classList.add('hidden');
                        sidebarContactBtn.classList.remove('flex');

                        desktopSearchContainer.classList.add('hidden');
                        mobileSearchBtn.classList.remove('hidden');
                    }
                } else { // >= 768px (Desktop Views)
                    if(state.isMobileSheetOpen) toggleMobileSheet(false);
                    sidebar.classList.remove('fixed', 'top-0', 'left-0', 'h-full', 'z-40');
                    sidebar.style.transform = 'translateX(0)';
                    state.isSidebarOpen = false;
                    
                    contactBtn.classList.remove('hidden');
                    sidebarContactBtn.classList.add('hidden');
                    sidebarContactBtn.classList.remove('flex');
                    
                    desktopSearchContainer.classList.remove('hidden');
                    mobileSearchBtn.classList.add('hidden');
                    
                    rightPanelsContainer.style.width = '375px';
                    if (width < 992) {
                        rightPanelsContainer.style.width = '300px';
                    }

                    if (state.isRightPanelOpen) {
                        rightPanelsContainer.classList.remove('hidden');
                        rightPanelsContainer.innerHTML = ''; // Clear previous panels
                        const panelToShow = state.rightPanelContent === 'history' ? historyPanel : aiPanel;
                        rightPanelsContainer.appendChild(panelToShow);
                    } else {
                        rightPanelsContainer.classList.add('hidden');
                    }
                }
                
                // Contact button text at 1024px
                if (width < 1024) {
                    contactBtnText.classList.add('hidden');
                    contactBtn.querySelector('.material-symbols-outlined').classList.remove('mr-1');
                } else {
                    contactBtnText.classList.remove('hidden');
                    contactBtn.querySelector('.material-symbols-outlined').classList.add('mr-1');
                }

                // Search bar position
                if (width < 992 && width >= 650) {
                    searchBarWrapper.classList.remove('justify-center');
                    searchBarWrapper.classList.add('justify-start');
                } else {
                    searchBarWrapper.classList.add('justify-center');
                    searchBarWrapper.classList.remove('justify-start');
                }

                // Sidebar collapse for desktop
                if (width >= 600 && width < 1190) {
                     sidebar.style.width = '70px';
                    document.querySelectorAll('.sidebar-text').forEach(el => el.classList.add('hidden'));
                } else if (width >= 1190) {
                    sidebar.style.width = '256px';
                    document.querySelectorAll('.sidebar-text').forEach(el => el.classList.remove('hidden'));
                }
            }
            
            function updateActiveNav(){
                 document.querySelectorAll('#sidebar-nav button').forEach(button => {
                    button.classList.toggle('bg-pink-600/50', button.dataset.page === state.currentPage);
                    button.classList.toggle('text-white', button.dataset.page === state.currentPage);
                })
            }

            function attachStandardCalculatorListeners() {
                const display = document.getElementById('display');
                const expressionDisplay = document.getElementById('expression-display');
                let currentInput = '0';
                let expression = '';
                let resetDisplay = false;

                function updateDisplay() {
                    display.innerText = formatDisplayNumber(currentInput);
                    expressionDisplay.innerText = expression.replace(/\*/g, '×').replace(/\//g, '÷');
                }
                
                function formatDisplayNumber(numStr) {
                    if (typeof numStr !== 'string') numStr = String(numStr);
                    if (numStr.length > 15) {
                        return parseFloat(numStr).toExponential(9);
                    }
                    return numStr;
                }

                function factorial(n) {
                    if (n < 0) return NaN;
                    if (n === 0) return 1;
                    let result = 1;
                    for (let i = 2; i <= n; i++) {
                        result *= i;
                    }
                    return result;
                }

                function safeEvaluate(expr) {
                    try {
                        // Replace user-friendly symbols with JS Math functions
                        let safeExpr = expr
                            .replace(/×/g, '*')
                            .replace(/÷/g, '/')
                            .replace(/π/g, 'Math.PI')
                            .replace(/e/g, 'Math.E')
                            .replace(/\^/g, '**');

                        // Handle trigonometry with DEG/RAD conversion
                        safeExpr = safeExpr.replace(/(sin|cos|tan)\(([^)]+)\)/g, (match, func, val) => {
                            const angle = parseFloat(eval(val));
                            const radAngle = state.calc.isRad ? angle : angle * (Math.PI / 180);
                            return `Math.${func}(${radAngle})`;
                        });
                        
                        // Final check for allowed characters
                        if (/^[0-9+\-*/().\s,MathPIE**]+$/.test(safeExpr.replace(/Math\.(sin|cos|tan|PI|E|sqrt|cbrt|log|log10|exp|pow|abs|sign)/g, ''))) {
                             return new Function('return ' + safeExpr)();
                        } else {
                            return 'Error';
                        }
                    } catch (e) {
                        return 'Error';
                    }
                }

                function handleInput(key) {
                    const lastChar = currentInput.slice(-1);
                    const isOperator = ['+', '-', '*', '/'].includes(lastChar);

                    if (/\d/.test(key) || key === '00') {
                        if (currentInput === '0' || resetDisplay) {
                            currentInput = key;
                        } else {
                            currentInput += key;
                        }
                        resetDisplay = false;
                    } else if (key === '.') {
                        if (!currentInput.includes('.')) {
                            currentInput += '.';
                        }
                    } else if (['+', '-', '*', '/'].includes(key)) {
                        if (resetDisplay) {
                            expression = display.innerText + key;
                            resetDisplay = false;
                        } else {
                            expression += currentInput + key;
                        }
                        currentInput = '0';
                    } else if (key === '=') {
                        if (expression) {
                            expression += currentInput;
                            const result = safeEvaluate(expression);
                            addToHistory(`${expression.replace(/\*/g, '×').replace(/\//g, '÷')} = ${result}`);
                            currentInput = String(result);
                            expression = '';
                            resetDisplay = true;
                        }
                    } else if (key === 'AC') {
                        currentInput = '0';
                        expression = '';
                        resetDisplay = false;
                    } else if (key === 'DEL') {
                        currentInput = currentInput.slice(0, -1) || '0';
                    } else if (key === '%') {
                        currentInput = String(parseFloat(currentInput) / 100);
                        resetDisplay = true;
                    } else if (key === 'toggle-more') {
                        state.calc.showMoreSci = !state.calc.showMoreSci;
                        document.getElementById('more-sci-functions').classList.toggle('visible');
                    } else if (key === 'rad-deg') {
                        state.calc.isRad = !state.calc.isRad;
                        renderPage('standard'); // Re-render to update the button text
                    }
                    // --- Advanced Functions ---
                    else if (state.settings.advancedMode) {
                        handleAdvancedInput(key);
                    }
                    updateDisplay();
                }

                function handleAdvancedInput(key) {
                    let val = parseFloat(currentInput);
                    switch (key) {
                        case '(': case ')': currentInput = currentInput === '0' ? key : currentInput + key; break;
                        case 'mc': state.calc.memory = 0; break;
                        case 'm+': state.calc.memory += val; break;
                        case 'm-': state.calc.memory -= val; break;
                        case 'mr': currentInput = String(state.calc.memory); break;
                        case '2nd': state.calc.is2ndFlipped = !state.calc.is2ndFlipped; renderPage('standard'); break;
                        case 'x^2': currentInput = String(Math.pow(val, 2)); resetDisplay = true; break;
                        case 'x^3': currentInput = String(Math.pow(val, 3)); resetDisplay = true; break;
                        case 'e^x': currentInput = String(Math.exp(val)); resetDisplay = true; break;
                        case '10^x': currentInput = String(Math.pow(10, val)); resetDisplay = true; break;
                        case '1/x': currentInput = String(1 / val); resetDisplay = true; break;
                        case 'sqrt': currentInput = String(Math.sqrt(val)); resetDisplay = true; break;
                        case 'cbrt': currentInput = String(Math.cbrt(val)); resetDisplay = true; break;
                        case '+/-': currentInput = String(val * -1); break;
                        case 'pi': currentInput = String(Math.PI); resetDisplay = true; break;
                        case 'e': currentInput = String(Math.E); resetDisplay = true; break;
                        case 'ln': currentInput = String(Math.log(val)); resetDisplay = true; break;
                        case 'log10': currentInput = String(Math.log10(val)); resetDisplay = true; break;
                        case 'x!': currentInput = String(factorial(val)); resetDisplay = true; break;
                        case 'sin': case 'cos': case 'tan':
                            const angle = state.calc.isRad ? val : val * (Math.PI / 180);
                            currentInput = String(Math[key](angle));
                            resetDisplay = true;
                            break;
                        case 'x^y': expression += currentInput + '^'; currentInput = '0'; break;
                        case 'y_sqrt_x': expression += currentInput + 'yroot'; currentInput = '0'; break; // Needs custom eval logic
                        case 'EE': currentInput += 'e+'; break;
                    }
                }

                document.getElementById('calculator').addEventListener('click', e => { 
                    if (e.target.matches('button')) handleInput(e.target.dataset.key); 
                });
                document.addEventListener('keydown', e => { 
                    if (state.currentPage !== 'standard') return;
                    const keyMap = {'Enter':'=','Backspace':'DEL','Escape':'AC','+':'+','-':'-','*':'*','/':'/','.':'.','0':'0','1':'1','2':'2','3':'3','4':'4','5':'5','6':'6','7':'7','8':'8','9':'9', '(': '(', ')': ')'};
                    if (keyMap[e.key]) {
                        e.preventDefault();
                        handleInput(keyMap[e.key]);
                    }
                });
            }

            function attachTimeCalculatorListeners() {
                const startTime = document.getElementById('start-time');
                const endTime = document.getElementById('end-time');
                const calcDiffBtn = document.getElementById('calc-diff-btn');
                const diffResult = document.getElementById('diff-result');

                const baseTime = document.getElementById('base-time');
                const addDays = document.getElementById('add-days');
                const addHours = document.getElementById('add-hours');
                const addMins = document.getElementById('add-mins');
                const addSecs = document.getElementById('add-secs');
                const addTimeBtn = document.getElementById('add-time-btn');
                const subtractTimeBtn = document.getElementById('subtract-time-btn');
                const addSubtractResult = document.getElementById('add-subtract-result');

                calcDiffBtn.addEventListener('click', () => {
                    if (!startTime.value || !endTime.value) {
                        diffResult.textContent = "Please select both a start and end date.";
                        return;
                    }
                    const start = new Date(startTime.value);
                    const end = new Date(endTime.value);
                    let diff = Math.abs(end - start);

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    diff -= days * (1000 * 60 * 60 * 24);
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    diff -= hours * (1000 * 60 * 60);
                    const mins = Math.floor(diff / (1000 * 60));
                    diff -= mins * (1000 * 60);
                    const secs = Math.floor(diff / 1000);

                    const resultString = `${days}d ${hours}h ${mins}m ${secs}s`;
                    diffResult.textContent = resultString;
                    addToHistory(`Time Diff: ${resultString}`);
                });
                
                function handleDurationCalc(isSubtract) {
                     if (!baseTime.value) {
                        addSubtractResult.textContent = "Please select a base date.";
                        return;
                    }
                    const base = new Date(baseTime.value);
                    const days = parseInt(addDays.value) || 0;
                    const hours = parseInt(addHours.value) || 0;
                    const mins = parseInt(addMins.value) || 0;
                    const secs = parseInt(addSecs.value) || 0;

                    let totalMs = secs * 1000;
                    totalMs += mins * 60 * 1000;
                    totalMs += hours * 60 * 60 * 1000;
                    totalMs += days * 24 * 60 * 60 * 1000;
                    
                    const newTime = isSubtract ? base.getTime() - totalMs : base.getTime() + totalMs;
                    const newDate = new Date(newTime);
                    
                    addSubtractResult.textContent = newDate.toLocaleString();
                    addToHistory(`Time Calc: ${newDate.toLocaleString()}`);
                }

                addTimeBtn.addEventListener('click', () => handleDurationCalc(false));
                subtractTimeBtn.addEventListener('click', () => handleDurationCalc(true));
            }

            function attachConverterListeners(type) {
                document.getElementById('convert-btn').addEventListener('click', () => {
                    const input=parseFloat(document.getElementById('converter-input').value), from=document.getElementById('from-unit').value, to=document.getElementById('to-unit').value, resDiv=document.getElementById('converter-result');
                    if(isNaN(input)){resDiv.innerText="Please enter a valid number.";resDiv.classList.add('text-red-400');return;} resDiv.classList.remove('text-red-400');
                    try{let res=convert(input, from, to, type); if(typeof res==='number'){const finRes=state.settings.showDecimals?res.toFixed(4):Math.round(res);resDiv.innerText=`${input} ${from} = ${finRes} ${to}`;addToHistory(`${type}: ${input} ${from} to ${to} = ${finRes}`);}else{resDiv.innerText=res;}}catch(e){resDiv.innerText=e.message;resDiv.classList.add('text-red-400');}
                });
            }
            
            function attachLikesDislikesListeners() {
                const likesInput=document.getElementById('likes-input'), dislikesInput=document.getElementById('dislikes-input'), submitBtn=document.getElementById('likes-submit-btn'), historyContainer=document.getElementById('likes-history-container');
                function renderLikesHistory(){ if(state.likesDislikesHistory.length===0){historyContainer.innerHTML=`<p class="text-slate-400">No entries yet.</p>`;return;}historyContainer.innerHTML=state.likesDislikesHistory.map(entry=>entry.html).join('');}
                submitBtn.addEventListener('click', () => {
                    const likes=parseInt(likesInput.value,10)||0, dislikes=parseInt(dislikesInput.value,10)||0; if(likes<0||dislikes<0)return;
                    const total=likes+dislikes, positivePercent=total===0?0:(likes/total)*100, entryNum=state.likesDislikesHistory.length+1, resultText=`Entry ${entryNum}: (${positivePercent.toFixed(1)}% positive) (${likes} likes, ${dislikes} dislikes)`;
                    const entryHTML=`<div class="bg-slate-800/50 p-3 rounded-lg"><p class="text-sm text-slate-300">${resultText}</p><div class="w-full bg-slate-700 rounded-full h-2.5 mt-2"><div class="bg-green-500 h-2.5 rounded-full" style="width:${positivePercent}%"></div></div></div>`;
                    state.likesDislikesHistory.unshift({html:entryHTML}); localStorage.setItem('likesDislikesHistory', JSON.stringify(state.likesDislikesHistory)); renderLikesHistory();
                    addToHistory(`Likes/Dislikes: ${resultText}`); likesInput.value=''; dislikesInput.value='';
                });
                renderLikesHistory();
            }

            function attachSettingsListeners() {
                const darkModeToggle=document.getElementById('dark-mode-toggle');
                const decimalsToggle=document.getElementById('decimals-toggle');
                const advancedModeToggle = document.getElementById('advanced-mode-toggle');

                darkModeToggle.checked=state.settings.darkMode; 
                decimalsToggle.checked=state.settings.showDecimals;
                advancedModeToggle.checked = state.settings.advancedMode;

                darkModeToggle.addEventListener('change',e=>{state.settings.darkMode=e.target.checked;localStorage.setItem('darkMode',state.settings.darkMode);updateUI();});
                decimalsToggle.addEventListener('change',e=>{state.settings.showDecimals=e.target.checked;localStorage.setItem('showDecimals',state.settings.showDecimals);updateUI();});
                advancedModeToggle.addEventListener('change', e => {
                    state.settings.advancedMode = e.target.checked;
                    localStorage.setItem('advancedMode', state.settings.advancedMode);
                    if (state.currentPage === 'standard') {
                        renderPage('standard'); // Re-render calculator to show/hide advanced buttons
                    }
                });
            }

            function handleAiQuery() {
                const inputElem = state.isMobileSheetOpen ? sheetContent.querySelector('#ai-input') : aiInput;
                const outputElem = state.isMobileSheetOpen ? sheetContent.querySelector('#ai-output') : aiOutput;
                const query = inputElem.value.trim().toLowerCase(); if(!query) return; let response='';
                try {
                    const percentMatch = query.match(/(\d+\.?\d*)\s*%\s*of\s*(\d+\.?\d*)/i);
                    const likesMatch = query.match(/(\d+)\s*likes\s*(\d+)\s*dislikes/i);

                    if (percentMatch) {
                        const p=parseFloat(percentMatch[1]),n=parseFloat(percentMatch[2]);response=`${p}% of ${n} is ${(p/100)*n}`;
                    } else if (likesMatch) {
                        const likes = parseInt(likesMatch[1]), dislikes = parseInt(likesMatch[2]);
                        const total = likes + dislikes;
                        const positivePercent = total === 0 ? 0 : (likes / total) * 100;
                        response = `${likes} likes and ${dislikes} dislikes is ${positivePercent.toFixed(1)}% positive.`;
                    } else {
                        const sanitizedQuery = query.replace(/[^-()\d/*+.]/g,'');
                        if(sanitizedQuery) {
                            response=`${query} = ${new Function('return '+sanitizedQuery)()}`;
                        } else {
                            response="Sorry, I can only solve math, time, and percentage problems.";
                        }
                    }
                } catch(e) {
                    response="Sorry, I couldn't understand that.";
                }
                outputElem.innerHTML+=`<div class="text-right text-blue-300 mb-2">${inputElem.value}</div><div class="text-left text-pink-300 mb-4">${response}</div>`; outputElem.scrollTop=outputElem.scrollHeight; inputElem.value=''; addToHistory(`AI: ${response}`);
            }

            function addToHistory(item) { state.history.unshift(item); if(state.history.length>50)state.history.pop(); localStorage.setItem('calculatorHistory',JSON.stringify(state.history)); renderHistory(historySearchInput.value); renderHistory(mobileHistorySearchInput.value);}
            
            function convert(v, f, t, type) {
                if (f === t) return v;
                const C = {
                    temp: { c: { f: val => val * 9 / 5 + 32, k: val => val + 273.15 }, f: { c: val => (val - 32) * 5 / 9, k: val => (val - 32) * 5 / 9 + 273.15 }, k: { c: val => val - 273.15, f: val => (val - 273.15) * 9 / 5 + 32 } },
                    weight: { kg: 1, g: 1000, lb: 2.20462, oz: 35.274 },
                    speed: { mps: 1, kmph: 3.6, mph: 2.23694, knots: 1.94384 },
                    length: { m: 1, km: 0.001, cm: 100, mi: 0.000621371, yd: 1.09361 },
                    pressure: { pa: 1, kpa: 0.001, bar: 1e-5, psi: 0.000145038, atm: 9.86923e-6 },
                    angle: { deg: 1, rad: 0.0174533, grad: 1.11111 },
                    currency: { usd: 1, eur: 0.93, gbp: 0.79, jpy: 157.6, cad: 1.37 },
                    storage: { b: 1, kb: 1 / 1024, mb: 1 / (1024 ** 2), gb: 1 / (1024 ** 3), tb: 1 / (1024 ** 4) },
                    fuel: { 'mpg_us': 1, 'l_100km': v => 235.214 / v, 'km_l': v => v * 0.425144 },
                    volume: { l: 1, ml: 1000, gal_us: 0.264172, m3: 0.001 },
                    area: { m2: 1, km2: 1e-6, mi2: 3.861e-7, acre: 0.000247105 },
                    power: { w: 1, kw: 0.001, hp: 0.00134102 },
                    energy: { j: 1, kj: 0.001, cal: 0.239006, kwh: 2.77778e-7 },
                    force: { n: 1, lbf: 0.224809 }
                };

                if (type === 'temp' || type === 'fuel') {
                    if (C[type][f] && C[type][f][t]) {
                         if(typeof C[type][f][t] === 'function') return C[type][f][t](v);
                         // Handle special cases like l/100km to others
                         if(f === 'l_100km' && t === 'mpg_us') return 235.214 / v;
                         if(f === 'l_100km' && t === 'km_l') return 100 / v;
                         if(f === 'km_l' && t === 'l_100km') return 100 / v;
                         if(f === 'mpg_us' && t === 'l_100km') return 235.214 / v;

                         // Fallback for simple conversions within fuel
                         const base_km_l = v * C[type][f];
                         return base_km_l / C[type][t];
                    }
                } else if (C[type]) {
                    const T = C[type];
                    if (T[f] && T[t]) {
                        const B = v / T[f];
                        return B * T[t];
                    }
                }
                throw new Error("Conversion not supported.");
            }

            // --- GLOBAL EVENT LISTENERS ---
            sidebarNav.addEventListener('click', e => { const btn=e.target.closest('button'); if (btn?.dataset.page){renderPage(btn.dataset.page); if(window.innerWidth<768){state.isSidebarOpen=false;updateUI();}}});
            menuBtn.addEventListener('click', () => { state.isSidebarOpen=true; updateUI(); });
            sidebarCloseBtn.addEventListener('click', () => { state.isSidebarOpen=false; updateUI(); });
            
            function handlePanelToggle(panelType) {
                const width = window.innerWidth;
                if (width < 768) {
                    state.mobileSheetContent = panelType;
                    toggleMobileSheet(true);
                } else {
                    if (state.isRightPanelOpen && state.rightPanelContent === panelType) {
                        state.isRightPanelOpen = false;
                    } else {
                        state.isRightPanelOpen = true;
                        state.rightPanelContent = panelType;
                    }
                    updateUI();
                }
            }

            historyBtn.addEventListener('click', () => handlePanelToggle('history'));
            aiBtn.addEventListener('click', () => handlePanelToggle('ai'));
            rightPanelCloseBtn.addEventListener('click', () => {
                state.isRightPanelOpen = false;
                updateUI();
            });
            
            function copyToClipboard(text) {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed'; ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(ta);
            }

            function handleHistoryActions(e) {
                const target = e.target.closest('button');
                if (!target) return;
                const index = parseInt(target.dataset.index, 10);
                if (target.classList.contains('copy-btn')) {
                    copyToClipboard(state.history[index]);
                } else if (target.classList.contains('delete-btn')) {
                    state.history.splice(index, 1);
                    localStorage.setItem('calculatorHistory', JSON.stringify(state.history));
                    renderHistory(historySearchInput.value);
                    renderHistory(mobileHistorySearchInput.value);
                }
            }
            historyList.addEventListener('click', handleHistoryActions);
            sheetContent.addEventListener('click', e => {
                if (sheetContent.contains(historyPanel)) handleHistoryActions(e);
            });

            function toggleMobileSheet(show){
                state.isMobileSheetOpen = show;
                mobileBottomSheet.style.transform = show ? 'translateY(0)' : 'translateY(100%)';
                if (show) {
                    sheetTitle.innerText = state.mobileSheetContent === 'history' ? 'History' : 'AI Assistant';
                    const panelToMove = state.mobileSheetContent === 'history' ? historyPanel : aiPanel;
                    sheetContent.appendChild(panelToMove);
                    renderHistory(mobileHistorySearchInput.value);
                } else {
                    const panelInSheet = sheetContent.children[0];
                    if (panelInSheet) {
                        panelTemplates.appendChild(panelInSheet);
                    }
                }
            }
            
            sheetCloseBtn.addEventListener('click', () => toggleMobileSheet(false));
            clearHistoryBtn.addEventListener('click', () => { state.history=[];localStorage.removeItem('calculatorHistory');renderHistory(historySearchInput.value);renderHistory(mobileHistorySearchInput.value); });
            
            const searchHandler = e => renderHistory(e.target.value);
            historySearchInput.addEventListener('input', searchHandler);
            mobileHistorySearchInput.addEventListener('input', searchHandler);
            
            aiSubmitBtn.addEventListener('click', handleAiQuery);
            aiInput.addEventListener('keydown', e => { if(e.key==='Enter')handleAiQuery(); });

            mobileSearchBtn.addEventListener('click', () => { mobileSearchView.classList.remove('hidden'); mobileHistorySearchInput.focus(); });
            mobileSearchBackBtn.addEventListener('click', () => { mobileSearchView.classList.add('hidden'); });

            document.addEventListener('keydown', e => { if(e.ctrlKey&&e.shiftKey){ if(e.key.toLowerCase()==='a'){e.preventDefault();aiBtn.click();} if(e.key.toLowerCase()==='h'){e.preventDefault();historyBtn.click();}}});
            window.addEventListener('resize', updateUI);

            // --- INITIALIZATION ---
            renderPage('standard');
            updateUI();
            renderHistory();
        });
    </script>
</body>
</html>
